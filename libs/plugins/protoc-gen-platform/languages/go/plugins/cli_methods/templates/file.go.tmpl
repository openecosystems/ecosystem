// Code generated by protoc-gen-platform {{ pluginName }}. DO NOT EDIT.
// source: {{ .File.InputPath }}
{{ $s := service .File }}{{ $version := getPackageVersionName .File }}{{ $versionLower := getPackageVersion .File }}{{ $apiType := getApiOptionsTypeName .File }}{{ $system := domainSystemName2 .File }}{{ $e := parentEntity . }}{{ $entityName := entityName $e }}{{ $entityNamePlural := entityNamePlural $e}}{{ $leadingComment := methodLeadingComment . }}{{ $trailingComments := methodTrailingComment . }}{{ $leadingDetachedComments := methodLeadingDetachedComments . }}{{ $methodShortName := getMethodShortName . }}

package {{ goPath .File }}

import (
    "connectrpc.com/connect"
    "context"
    "encoding/json"
    "fmt"
    "github.com/openecosystems/ecosystem/libs/public/go/sdk/v2alpha"
    "os"
    "github.com/apex/log"
    "google.golang.org/protobuf/encoding/protojson"
    "github.com/spf13/cobra"
{{ if ne (getApiOptionsNetwork . ) "overlay" -}}
    "net/http"
    "github.com/openecosystems/ecosystem/libs/{{ $apiType }}/go/sdk/gen/platform/{{ $system.LowerCamelCase }}/{{ $versionLower }}/{{ $system.LowerCamelCase }}{{ $versionLower }}pbconnect"
{{ else -}}

{{ end }}

{{ range getImportPackages .File }}
    //"{{ . }}"
{{ end }}
)

var (
  {{ .Name.LowerCamelCase }}Request string
  {{ .Name.LowerCamelCase }}FieldMask   string
  {{ .Name.LowerCamelCase }}ValidateOnly bool
)

var {{ .Name }}{{ $version.UpperCamelCase }}Cmd = &cobra.Command{
    Use:   "{{ $methodShortName.LowerCamelCase }}",
    Short: `{{- $leadingComment -}}`,
    Long:  `{{- $leadingDetachedComments -}}`,
    Run: func(cmd *cobra.Command, args []string) {

        log.Debug("Calling {{ .Name.LowerCamelCase }} {{ $entityName.LowerCamelCase }}")
        settings := cmd.Root().Context().Value(sdkv2alphalib.SettingsContextKey).(*sdkv2alphalib.CLIConfiguration)

        _request, err := cmd.Flags().GetString("request")
        if err != nil {
          fmt.Println(err)
          os.Exit(1)
        }
        if _request == "" {
          _request = "{}"
        }

        _r := {{ .Input.Name.UpperCamelCase }}{}
        err = protojson.Unmarshal([]byte(_request), &_r)
        if err != nil {
          fmt.Println(err)
          os.Exit(1)
        }

        sdkv2alphalib.Overrides.FieldMask = {{ .Name.LowerCamelCase }}FieldMask
        sdkv2alphalib.Overrides.ValidateOnly = {{ .Name.LowerCamelCase }}ValidateOnly

        request := connect.NewRequest[{{ .Input.Name.UpperCamelCase }}](&_r)
        // Add GZIP Support: connect.WithSendGzip(),
        {{ if ne (getApiOptionsNetwork . ) "overlay" -}}
        httpClient := http.DefaultClient
        url := "https://" + settings.Platform.Endpoint
		if settings.Platform.Insecure {
			url = "http://" + settings.Platform.Endpoint
		}
        client := {{ getImportName .Input }}connect.NewAccountServiceClient(httpClient, url, connect.WithInterceptors(sdkv2alphalib.NewCLIInterceptor(settings, sdkv2alphalib.Overrides)))
        {{ else -}}
        url := "https://" + settings.Platform.Mesh.Endpoint
		if settings.Platform.Insecure {
			url = "http://" + settings.Platform.Mesh.Endpoint
		}
        client := *New{{ $entityName.UpperCamelCase }}ServiceSpecClient(&settings.Platform, url, connect.WithInterceptors(sdkv2alphalib.NewCLIInterceptor(settings, sdkv2alphalib.Overrides)))
        {{ end }}

        response, err := client.{{ .Name }}(context.Background(), request)
        if err != nil {
          fmt.Println(err)
          os.Exit(1)
        }

        val, _ := json.MarshalIndent(&response, "", "    ")
        fmt.Println(string(val))
    },
}

func init() {
  {{ .Name }}{{ $version.UpperCamelCase }}Cmd.PersistentFlags().StringVarP(&{{ .Name.LowerCamelCase }}Request, "request", "r", "{}", "Request for api call")
  {{ .Name }}{{ $version.UpperCamelCase }}Cmd.PersistentFlags().BoolVar(&{{ .Name.LowerCamelCase }}ValidateOnly,"validate-only", false, "Only validate this request without modifying the resource")
  {{ .Name }}{{ $version.UpperCamelCase }}Cmd.PersistentFlags().StringVarP(&{{ .Name.LowerCamelCase }}FieldMask, "field-mask", "m", "", "Limit the returned response fields")
}
